<Page x:Class="LinuxGate.Pages.ResizeDisk"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
      xmlns:local="clr-namespace:LinuxGate.Pages"
      xmlns:controls="clr-namespace:LinuxGate.Controls"
      mc:Ignorable="d"
      Title="Resize Disk">

    <Page.Resources>
        <Style x:Key="SliderRepeatButton" TargetType="RepeatButton">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="RepeatButton">
                        <Border Height="4" CornerRadius="2" Background="{TemplateBinding Background}"/>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="SliderThumb" TargetType="Thumb">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Thumb">
                        <Grid>
                            <Ellipse Width="20" Height="20" Fill="#3e8fb0"/>
                            <Ellipse Width="16" Height="16" Fill="#232136"/>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="CustomSlider" TargetType="Slider">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Slider">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto" MinHeight="{TemplateBinding MinHeight}"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <Track Grid.Row="1" x:Name="PART_Track">
                                <Track.DecreaseRepeatButton>
                                    <RepeatButton Style="{StaticResource SliderRepeatButton}" Background="#3e8fb0"/>
                                </Track.DecreaseRepeatButton>
                                <Track.IncreaseRepeatButton>
                                    <RepeatButton Style="{StaticResource SliderRepeatButton}" Background="#363252"/>
                                </Track.IncreaseRepeatButton>
                                <Track.Thumb>
                                    <Thumb Style="{StaticResource SliderThumb}"/>
                                </Track.Thumb>
                            </Track>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Page.Resources>

    <Grid Background="#232136">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <Label Grid.Row="0" 
               Content="{DynamicResource ResizeDiskTitle}" 
               HorizontalAlignment="Center" 
               Margin="20"
               FontSize="48"
               FontWeight="Light"
               Foreground="#E0DEF4"/>

        <!-- Disk visualization - GParted style -->
        <Border Grid.Row="1"
                Height="100"
                Margin="40,20"
                BorderThickness="1"
                BorderBrush="#908caa"
                CornerRadius="4"
                ClipToBounds="True">
            <Grid x:Name="DiskVisualization">
                <Grid.ColumnDefinitions>
                    <!-- Windows partition (total) -->
                    <ColumnDefinition Width="{Binding WindowsPartitionPercentage}"/>
                    <!-- Linux installation partition -->
                    <ColumnDefinition Width="{Binding LinuxPartitionPercentage}"/>
                </Grid.ColumnDefinitions>

                <!-- Windows Partition GParted style: 3 layers - ultra dark contour, dark used, light free -->
                <Border Grid.Column="0" Background="#1e5570" CornerRadius="3" Padding="6">
                    <Grid>
                        <!-- Inner fill showing used/free space proportion -->
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="{Binding WindowsUsedPercentage}"/>
                                <ColumnDefinition Width="{Binding WindowsFreeInPartitionPercentage}"/>
                            </Grid.ColumnDefinitions>
                            <!-- Used space - dark blue -->
                            <Rectangle Grid.Column="0" Fill="#2d7090" RadiusX="2" RadiusY="2"/>
                            <!-- Free space - light blue -->
                            <Rectangle Grid.Column="1" Fill="#3e8fb0" RadiusX="2" RadiusY="2"/>
                        </Grid>

                        <!-- Windows label centered -->
                        <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                            <TextBlock Text="{DynamicResource Windows}"
                                       Foreground="#E0DEF4"
                                       FontWeight="SemiBold"
                                       HorizontalAlignment="Center"/>
                            <TextBlock Text="{Binding WindowsFreeSpace, StringFormat={}{0:N0} GB free}"
                                       Foreground="#E0DEF4"
                                       FontSize="12"
                                       Opacity="0.8"
                                       HorizontalAlignment="Center"/>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- Linux Installation Partition -->
                <Grid Grid.Column="1">
                    <Rectangle Fill="#eb6f92" RadiusX="3" RadiusY="3"/>
                    <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                        <TextBlock Text="{DynamicResource Linux}"
                                   Foreground="#232136"
                                   FontWeight="SemiBold"
                                   HorizontalAlignment="Center"/>
                        <TextBlock Text="{Binding LinuxSize, StringFormat={}{0:N0} GB}"
                                   Foreground="#232136"
                                   FontSize="12"
                                   HorizontalAlignment="Center"/>
                    </StackPanel>
                </Grid>
            </Grid>
        </Border>

        <!-- Legend -->
        <StackPanel Grid.Row="1"
                    Orientation="Horizontal"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Bottom"
                    Margin="0,0,0,-5">
            <StackPanel Orientation="Horizontal" Margin="10,0">
                <Rectangle Width="16" Height="16" Fill="#1e5570" RadiusX="2" RadiusY="2" Margin="0,0,5,0"/>
                <TextBlock Text="{Binding WindowsUsedSpace, StringFormat=Windows used: {0:N0} GB}"
                           Foreground="#908caa" FontSize="11" VerticalAlignment="Center"/>
            </StackPanel>
            <StackPanel Orientation="Horizontal" Margin="10,0">
                <Rectangle Width="16" Height="16" Fill="#3e8fb0" RadiusX="2" RadiusY="2" Margin="0,0,5,0"/>
                <TextBlock Text="{Binding WindowsFreeSpace, StringFormat=Windows free: {0:N0} GB}"
                           Foreground="#908caa" FontSize="11" VerticalAlignment="Center"/>
            </StackPanel>
            <StackPanel Orientation="Horizontal" Margin="10,0">
                <Rectangle Width="16" Height="16" Fill="#eb6f92" RadiusX="2" RadiusY="2" Margin="0,0,5,0"/>
                <TextBlock Text="{Binding LinuxSize, StringFormat=Linux: {0:N0} GB}"
                           Foreground="#908caa" FontSize="11" VerticalAlignment="Center"/>
            </StackPanel>
        </StackPanel>

        <!-- Slider and size display -->
        <StackPanel Grid.Row="2" Margin="40,20">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <Slider x:Name="PartitionSlider"
                        Style="{StaticResource CustomSlider}"
                        Minimum="{Binding MinimumSize}"
                        Maximum="{Binding MaximumSize}"
                        Value="{Binding SelectedSize, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                        TickFrequency="1"
                        IsSnapToTickEnabled="True"/>
                
                <TextBox Grid.Column="1"
                         Width="80"
                         Height="30"
                         Margin="20,0,5,0"
                         Background="#2a273f"
                         Foreground="#E0DEF4"
                         BorderBrush="#363252"
                         TextAlignment="Center"
                         VerticalContentAlignment="Center"
                         Text="{Binding SelectedSize, StringFormat={}{0:F0}, UpdateSourceTrigger=PropertyChanged}"
                         PreviewTextInput="NumberValidationTextBox"/>
                
                <TextBlock Grid.Column="2"
                          VerticalAlignment="Center"
                          Foreground="#E0DEF4"
                          Text="GB"/>
            </Grid>

            <!-- Size Error Message -->
            <TextBlock Margin="0,5,0,0"
                       Foreground="#eb6f92"
                       Text="{Binding SizeErrorMessage}"
                       Visibility="{Binding HasSizeError, Converter={StaticResource BoolToVisibilityConverter}}"/>

            <!-- Size breakdown -->
            <Grid Margin="0,20,0,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- Windows info -->
                <StackPanel Grid.Column="0">
                    <TextBlock Foreground="#3e8fb0" FontWeight="SemiBold"
                               Text="{Binding WindowsTotalSpace, StringFormat=Windows: {0:N0} GB}"/>
                    <TextBlock Foreground="#908caa" FontSize="12" Margin="10,2,0,0"
                               Text="{Binding WindowsUsedSpace, StringFormat=Used: {0:N0} GB}"/>
                    <TextBlock Foreground="#908caa" FontSize="12" Margin="10,2,0,0"
                               Text="{Binding WindowsFreeSpace, StringFormat=Free: {0:N0} GB}"/>
                </StackPanel>

                <!-- Linux info -->
                <StackPanel Grid.Column="1">
                    <TextBlock Foreground="#eb6f92" FontWeight="SemiBold"
                               Text="{Binding LinuxSize, StringFormat=Linux: {0:N0} GB}"/>
                </StackPanel>
            </Grid>
        </StackPanel>

        <!-- Error Panel -->
        <controls:ErrorPanel x:Name="FallbackPanel"
                           Grid.Row="1"
                           Grid.RowSpan="2"
                           Visibility="{Binding HasError, Converter={StaticResource BoolToVisibilityConverter}}"
                           MaxWidth="800"
                           Margin="40"
                           Title="{DynamicResource NotEnoughSpace}"
                           Message="{DynamicResource FreeUpSpace}"
                           Details="{Binding SystemRequirements}"
                           AdditionalDetails="{Binding AdditionalSpaceNeeded}"
                           ActionButtonText="{DynamicResource OpenDiskCleanup}"
                           ActionCommand="{Binding OpenDiskCleanupCommand}"/>

        <Grid Grid.Row="3" Margin="20">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            
            <Button Content="{DynamicResource Back}"
                    Style="{StaticResource ModernButton}"
                    Width="200"
                    Height="50"
                    HorizontalAlignment="Left"
                    Click="BackButton_Click"/>
                    
            <Button Grid.Column="1"
                    Content="{DynamicResource Next}"
                    Width="200"
                    Height="50"
                    HorizontalAlignment="Right"
                    Click="NextButton_Click">
                <Button.Style>
                    <Style TargetType="Button" BasedOn="{StaticResource ModernButton}">
                        <Setter Property="IsEnabled" Value="False"/>
                        <Style.Triggers>
                            <MultiDataTrigger>
                                <MultiDataTrigger.Conditions>
                                    <Condition Binding="{Binding HasError}" Value="False"/>
                                    <Condition Binding="{Binding HasSizeError}" Value="False"/>
                                </MultiDataTrigger.Conditions>
                                <Setter Property="IsEnabled" Value="True"/>
                            </MultiDataTrigger>
                        </Style.Triggers>
                    </Style>
                </Button.Style>
            </Button>
        </Grid>
    </Grid>
</Page>
